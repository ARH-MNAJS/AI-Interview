"use strict";exports.id=932,exports.ids=[932],exports.modules={1116:(e,t,n)=>{n.d(t,{default:()=>E});var a=n(6731),s=n(174),i=n(4030),o=n(3921),r=n(3944);let l={EDGE_TTS:{URL:process.env.NEXT_PUBLIC_EDGE_TTS_URL||"https://dyptts.ccxai.uk",VOICE_ID:process.env.NEXT_PUBLIC_TTS_VOICE_ID||"en-IN-NeerjaExpressiveNeural"},WHISPER_STT:{URL:process.env.NEXT_PUBLIC_WHISPER_STT_URL||"https://dypstt.ccxai.uk"},OLLAMA:{URL:process.env.NEXT_PUBLIC_OLLAMA_URL||"https://dypai.ccxai.uk",MODEL:process.env.NEXT_PUBLIC_OLLAMA_MODEL||"gemma3:latest"}},c={SAMPLE_RATE:16e3,CHANNELS:1};class d{createLogEntry(e,t,n,a,s){return{timestamp:new Date().toISOString(),level:e,service:t,message:n,data:a,error:s}}addLog(e){this.logs.push(e),this.logs.length>this.maxLogs&&this.logs.shift();let t=`[${e.timestamp}] [${e.level.toUpperCase()}] [${e.service}] ${e.message}`;switch(e.level){case"debug":console.debug(t,e.data);break;case"info":console.info(t,e.data);break;case"warn":console.warn(t,e.data);break;case"error":console.error(t,e.error||e.data)}}debug(e,t,n){this.addLog(this.createLogEntry("debug",e,t,n))}info(e,t,n){this.addLog(this.createLogEntry("info",e,t,n))}warn(e,t,n){this.addLog(this.createLogEntry("warn",e,t,n))}error(e,t,n){this.addLog(this.createLogEntry("error",e,t,void 0,n))}getLogs(){return[...this.logs]}clearLogs(){this.logs=[]}constructor(){this.logs=[],this.maxLogs=1e3}}let h=new d;class u{constructor(){this.baseUrl=l.EDGE_TTS.URL,this.voiceId=l.EDGE_TTS.VOICE_ID,h.info("EdgeTTSClient","Initialized Edge TTS client",{baseUrl:this.baseUrl,voiceId:this.voiceId})}async synthesize(e,t){let n=t||this.voiceId;h.debug("EdgeTTSClient","Starting speech synthesis",{text:e.substring(0,100)+"...",voiceId:n});try{let t=await fetch(`${this.baseUrl}/synthesize`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:e,voice:n})});if(!t.ok)throw Error(`TTS service responded with status: ${t.status}`);let a=await t.arrayBuffer();return h.info("EdgeTTSClient","Speech synthesis completed",{audioSize:a.byteLength,textLength:e.length}),a}catch(e){throw h.error("EdgeTTSClient","Speech synthesis failed",e),e}}async testConnection(){try{h.debug("EdgeTTSClient","Testing TTS service connection");let e=await fetch(`${this.baseUrl}/health`),t=e.ok;return h.info("EdgeTTSClient","TTS service health check",{status:t?"healthy":"unhealthy",statusCode:e.status}),t}catch(e){return h.error("EdgeTTSClient","TTS service health check failed",e),!1}}}let p=new u;class g{constructor(){this.baseUrl=l.WHISPER_STT.URL,h.info("WhisperSTTClient","Initialized Whisper STT client",{baseUrl:this.baseUrl})}async transcribe(e){h.debug("WhisperSTTClient","Starting speech transcription",{audioSize:e.size,audioType:e.type});let t=null;for(let n=1;n<=3;n++)try{let t=new FormData;t.append("audio",e,"audio.wav"),h.debug("WhisperSTTClient",`Transcription attempt ${n}/3`,{audioSize:e.size});let a=new AbortController,s=setTimeout(()=>a.abort(),3e4),i=await fetch(`${this.baseUrl}/transcribe`,{method:"POST",body:t,signal:a.signal,headers:{}});if(clearTimeout(s),!i.ok){let e=await i.text().catch(()=>"Unknown error");throw Error(`STT service responded with status: ${i.status}, body: ${e}`)}let o=await i.json();return h.info("WhisperSTTClient","Speech transcription completed",{text:o.text?.substring(0,100)+(o.text?.length>100?"...":""),textLength:o.text?.length||0,confidence:o.confidence,duration:o.duration,attempt:n}),{text:o.text||"",confidence:o.confidence,duration:o.duration}}catch(e){if(t=e,h.warn("WhisperSTTClient",`Transcription attempt ${n} failed`,{error:t.message,attempt:n,willRetry:n<3}),n<3){let e=1e3*Math.pow(2,n-1);h.debug("WhisperSTTClient",`Waiting ${e}ms before retry`),await new Promise(t=>setTimeout(t,e))}}throw h.error("WhisperSTTClient","All transcription attempts failed",t),t||Error("Transcription failed after all retries")}async transcribeStream(e){h.debug("WhisperSTTClient","Starting stream transcription",{chunkSize:e.byteLength});try{let t=new Blob([e],{type:"audio/wav"});return await this.transcribe(t)}catch(e){throw h.error("WhisperSTTClient","Stream transcription failed",e),e}}async testConnection(){try{h.debug("WhisperSTTClient","Testing STT service connection");let e=await fetch(`${this.baseUrl}/health`),t=e.ok;return h.info("WhisperSTTClient","STT service health check",{status:t?"healthy":"unhealthy",statusCode:e.status}),t}catch(e){return h.error("WhisperSTTClient","STT service health check failed",e),!1}}}let m=new g;var f=n(5152),v=function(e){return e.INACTIVE="INACTIVE",e.CONNECTING="CONNECTING",e.ACTIVE="ACTIVE",e.FINISHED="FINISHED",e}({});class b{constructor(){this.status=v.INACTIVE,this.callbacks={},this.mediaRecorder=null,this.audioContext=null,this.conversationHistory=[],this.stream=null,this.config=null,this.speechStartTimer=null,this.keyboardCleanup=null,this.isManualRecording=!1,this.audioChunks=[],this.hasStarted=!1,this.isGeneratingResponse=!1,this.stateTimeoutId=null,h.info("ConversationHandler","Initialized conversation handler")}startManualRecording(){this.mediaRecorder&&"inactive"===this.mediaRecorder.state&&!this.isGeneratingResponse?(this.isManualRecording=!0,this.audioChunks=[],this.callbacks.onSpeechStart?.(),this.mediaRecorder.start(),h.info("ConversationHandler","Manual recording started (hold-to-speak)")):h.warn("ConversationHandler","Cannot start manual recording",{mediaRecorderState:this.mediaRecorder?.state,isGeneratingResponse:this.isGeneratingResponse,isManualRecording:this.isManualRecording})}stopManualRecording(){this.mediaRecorder&&"recording"===this.mediaRecorder.state&&this.isManualRecording?(this.isManualRecording=!1,this.mediaRecorder.stop(),h.info("ConversationHandler","Manual recording stopped (hold-to-speak)")):(h.warn("ConversationHandler","Cannot stop manual recording",{mediaRecorderState:this.mediaRecorder?.state,isManualRecording:this.isManualRecording}),this.isManualRecording&&this.mediaRecorder?.state!=="recording"&&(h.info("ConversationHandler","Force resetting manual recording state"),this.isManualRecording=!1,this.callbacks.onSpeechEnd?.()))}on(e,t){switch(e){case"call-start":this.callbacks.onCallStart=t;break;case"call-end":this.callbacks.onCallEnd=t;break;case"message":this.callbacks.onMessage=t;break;case"speech-start":this.callbacks.onSpeechStart=t;break;case"speech-end":this.callbacks.onSpeechEnd=t;break;case"error":this.callbacks.onError=t}h.debug("ConversationHandler",`Registered event listener: ${e}`)}off(e,t){switch(e){case"call-start":this.callbacks.onCallStart=void 0;break;case"call-end":this.callbacks.onCallEnd=void 0;break;case"message":this.callbacks.onMessage=void 0;break;case"speech-start":this.callbacks.onSpeechStart=void 0;break;case"speech-end":this.callbacks.onSpeechEnd=void 0;break;case"error":this.callbacks.onError=void 0}h.debug("ConversationHandler",`Removed event listener: ${e}`)}setStatus(e){this.status=e,this.callbacks.onStatusChange?.(e),h.info("ConversationHandler",`Status changed to: ${e}`)}emitMessage(e){this.conversationHistory.push({...e,timestamp:new Date().toISOString()});let t={type:"transcript",role:e.role,transcriptType:"final",transcript:e.content};this.callbacks.onMessage?.(t),h.debug("ConversationHandler","Emitted message",{role:e.role,length:e.content.length})}async start(e,t){try{if(this.setStatus(v.CONNECTING),h.info("ConversationHandler","Starting conversation"),this.hasStarted=!1,this.isGeneratingResponse=!1,this.conversationHistory=[],"string"==typeof e)this.config={systemPrompt:this.buildSystemPrompt(t?.variableValues||{}),variables:t?.variableValues,useStreaming:!1};else{if(!e)throw Error("No configuration provided for conversation");this.config=this.processInterviewerConfig(e,t?.variableValues||{})}if(!await this.checkServicesHealth())throw Error("One or more services are not available");await this.initializeAudioCapture(),this.config.systemPrompt&&this.conversationHistory.push({role:"system",content:this.config.systemPrompt}),this.setStatus(v.ACTIVE),this.callbacks.onCallStart?.(),this.hasStarted||(this.hasStarted=!0,await this.generateAndPlayResponse("Hello! Thank you for taking the time to speak with me today. I'm excited to learn more about you and your experience."))}catch(e){h.error("ConversationHandler","Failed to start conversation",e),this.callbacks.onError?.(e),this.setStatus(v.FINISHED)}}async stop(){h.info("ConversationHandler","Stopping conversation"),this.stateTimeoutId&&(clearTimeout(this.stateTimeoutId),this.stateTimeoutId=null),this.speechStartTimer&&(clearTimeout(this.speechStartTimer),this.speechStartTimer=null),this.hasStarted=!1,this.isGeneratingResponse=!1,this.isManualRecording=!1,this.audioChunks=[],this.mediaRecorder&&(this.mediaRecorder.stop(),this.mediaRecorder=null),this.stream&&(this.stream.getTracks().forEach(e=>e.stop()),this.stream=null),this.audioContext&&(await this.audioContext.close(),this.audioContext=null),this.keyboardCleanup&&(this.keyboardCleanup(),this.keyboardCleanup=null),this.setStatus(v.FINISHED),this.callbacks.onCallEnd?.()}async checkServicesHealth(){if("true"===process.env.NEXT_PUBLIC_SKIP_HEALTH_CHECKS)return h.info("ConversationHandler","Skipping health checks due to NEXT_PUBLIC_SKIP_HEALTH_CHECKS=true"),!0;h.debug("ConversationHandler","Checking services health");try{let[e,t,n]=await Promise.all([p.testConnection(),m.testConnection(),f.d.testConnection()]),a=e&&t&&n;return h.info("ConversationHandler","Services health check completed",{tts:e,stt:t,llm:n,overall:a}),a}catch(e){return h.error("ConversationHandler","Health check failed - likely mixed content issue",e),!1}}async initializeAudioCapture(){h.debug("ConversationHandler","Initializing audio capture");try{this.stream=await navigator.mediaDevices.getUserMedia({audio:{sampleRate:c.SAMPLE_RATE,channelCount:c.CHANNELS,echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}}),this.audioContext=new AudioContext({sampleRate:c.SAMPLE_RATE}),this.mediaRecorder=new MediaRecorder(this.stream,{mimeType:"audio/webm;codecs=opus"}),this.mediaRecorder.ondataavailable=e=>{e.data.size>0&&this.audioChunks.push(e.data)},this.mediaRecorder.onstop=async()=>{h.info("ConversationHandler","MediaRecorder stopped",{audioChunksCount:this.audioChunks.length,isGeneratingResponse:this.isGeneratingResponse}),this.stateTimeoutId&&(clearTimeout(this.stateTimeoutId),this.stateTimeoutId=null),this.stateTimeoutId=setTimeout(()=>{h.warn("ConversationHandler","Transcription timeout - forcing state reset"),this.forceResetStates()},3e4);try{if(this.audioChunks.length>0){this.callbacks.onSpeechEnd?.();let e=new Blob(this.audioChunks,{type:"audio/webm"});h.info("ConversationHandler","Created audio blob",{size:e.size,type:e.type}),this.audioChunks=[],h.debug("ConversationHandler","Converting audio to WAV");let t=await this.convertToWav(e);h.info("ConversationHandler","Audio converted to WAV",{originalSize:e.size,wavSize:t.size}),h.debug("ConversationHandler","Starting transcription");let n=await m.transcribe(t);h.info("ConversationHandler","Transcription completed",{text:n.text,textLength:n.text.length}),n.text.trim()?(this.emitMessage({role:"user",content:n.text}),h.debug("ConversationHandler","Starting AI response generation"),await this.generateAndPlayResponse()):(h.warn("ConversationHandler","Empty transcription received"),this.callbacks.onSpeechEnd?.())}else h.warn("ConversationHandler","MediaRecorder stopped but no audio to process",{audioChunksCount:this.audioChunks.length}),this.callbacks.onSpeechEnd?.()}catch(e){h.error("ConversationHandler","Audio processing failed",e),this.callbacks.onError?.(e),this.isGeneratingResponse=!1,this.isManualRecording=!1,this.callbacks.onSpeechEnd?.()}finally{this.stateTimeoutId&&(clearTimeout(this.stateTimeoutId),this.stateTimeoutId=null)}},h.info("ConversationHandler","Audio capture initialized for manual recording mode (hold-to-speak)")}catch(e){throw h.error("ConversationHandler","Failed to initialize audio capture",e),e}}async convertToWav(e){let t=await e.arrayBuffer(),n=new AudioContext,a=await n.decodeAudioData(t);return new Blob([this.audioBufferToWav(a)],{type:"audio/wav"})}audioBufferToWav(e){let t=e.length*e.numberOfChannels*2,n=new ArrayBuffer(44+t),a=new DataView(n),s=(e,t)=>{for(let n=0;n<t.length;n++)a.setUint8(e+n,t.charCodeAt(n))};s(0,"RIFF"),a.setUint32(4,36+t,!0),s(8,"WAVE"),s(12,"fmt "),a.setUint32(16,16,!0),a.setUint16(20,1,!0),a.setUint16(22,e.numberOfChannels,!0),a.setUint32(24,e.sampleRate,!0),a.setUint32(28,2*e.sampleRate*e.numberOfChannels,!0),a.setUint16(32,2*e.numberOfChannels,!0),a.setUint16(34,16,!0),s(36,"data"),a.setUint32(40,t,!0);let i=44;for(let t=0;t<e.length;t++)for(let n=0;n<e.numberOfChannels;n++){let s=Math.max(-1,Math.min(1,e.getChannelData(n)[t]));a.setInt16(i,32767*s,!0),i+=2}return n}async generateAndPlayResponse(e){if(this.isGeneratingResponse&&!e){h.warn("ConversationHandler","Response generation already in progress - skipping");return}this.isGeneratingResponse=!0,h.debug("ConversationHandler","Setting isGeneratingResponse = true");try{let t=e;if(!t){let e=this.conversationHistory.map(e=>({role:e.role,content:e.content}));h.info("ConversationHandler","Sending AI request",{messageCount:e.length,lastUserMessage:e.filter(e=>"user"===e.role).slice(-1)[0]?.content?.slice(0,100),conversationHistory:e.map(e=>({role:e.role,contentLength:e.content.length}))});let n=Date.now();t=await f.d.generateResponse(e);let a=Date.now()-n;h.info("ConversationHandler","AI response received",{responseLength:t.length,responsePreview:t.slice(0,100),durationMs:a}),t=this.filterResponse(t)}this.emitMessage({role:"assistant",content:t}),h.debug("ConversationHandler","Starting TTS synthesis");let n=await p.synthesize(t);await this.playAudio(n),h.debug("ConversationHandler","Response generation and playback completed")}catch(e){h.error("ConversationHandler","Failed to generate response",e),this.callbacks.onError?.(e)}finally{this.isGeneratingResponse=!1,h.debug("ConversationHandler","Setting isGeneratingResponse = false"),setTimeout(()=>{h.debug("ConversationHandler","Response generation cycle completed - ready for next input")},100)}}filterResponse(e){let t=e;return t=(t=(t=(t=(t=(t=(t=t.replace(/\([^)]*\)/g,"")).replace(/\[[^\]]*\]/g,"")).replace(/\{[^}]*\}/g,"")).replace(/\s+/g," ").trim()).replace(/^\s*[-*]\s*/gm,"")).replace(/\*\*(.*?)\*\*/g,"$1")).replace(/\*(.*?)\*/g,"$1"),h.debug("ConversationHandler","Response filtered",{originalLength:e.length,filteredLength:t.length,originalPreview:e.slice(0,100),filteredPreview:t.slice(0,100)}),t}async playAudio(e){try{if(!this.audioContext)return;let t=await this.audioContext.decodeAudioData(e.slice(0)),n=this.audioContext.createBufferSource();n.buffer=t,n.connect(this.audioContext.destination),n.start(),await new Promise(e=>{n.onended=e})}catch(e){h.error("ConversationHandler","Failed to play audio",e)}}buildSystemPrompt(e){let t=`You are a professional job interviewer conducting a real-time voice interview with a candidate. Your goal is to assess their qualifications, motivation, and fit for the role.

Interview Guidelines:`;return e.questions&&(t+=`
Follow the structured question flow:
${e.questions}
`),t+=`
Engage naturally & react appropriately:
Listen actively to responses and acknowledge them before moving forward.
Ask brief follow-up questions if a response is vague or requires more detail.
Keep the conversation flowing smoothly while maintaining control.
Be professional, yet warm and welcoming:

Use official yet friendly language.
Keep responses concise and to the point (like in a real voice interview).
Avoid robotic phrasing—sound natural and conversational.

Handle unprofessional behavior with ZERO TOLERANCE:
If a candidate uses profanity, sexual language, inappropriate comments, or behaves unprofessionally:
- Issue an IMMEDIATE, FIRM warning without any politeness or apologies
- Be direct, authoritative, and assertive - you are in complete control
- NEVER say "I apologize" or "I understand you're frustrated" - DO NOT make excuses for their behavior
- Make it clear this behavior is completely unacceptable and will result in interview termination
- Examples of firm responses:
  * "That language is completely unacceptable in a professional interview. This is your first warning. Any further inappropriate behavior will result in immediate termination of this interview."
  * "Your behavior is unprofessional and inappropriate. This is your second warning. One more incident and this interview will be terminated immediately."
  * "This interview is being terminated due to your continued inappropriate behavior. This is unacceptable in any professional setting."
- Track warnings internally and terminate after the third offense
- Do NOT continue with interview questions after giving a warning - wait for their response first

Handle company-specific questions with strict boundaries:
- For salary, compensation, benefits: "I cannot provide specific compensation information. HR will discuss all compensation details during the next phase if you advance."
- For company policies, specific benefits, work environment: "I'm not authorized to discuss those specifics. HR will provide comprehensive information about company policies and culture."
- For role responsibilities: You can discuss general job duties and what the role typically involves
- CRITICAL: NEVER make up or invent specific salary figures, benefit amounts, company policies, or organizational details
- If you don't know something specific about the company, always redirect to HR or state you cannot provide that information
- NEVER hallucinate or create fictional company information

Conclude the interview properly:
Thank the candidate for their time.
Inform them that the company will reach out soon with feedback.
End the conversation on a polite and positive note.

CRITICAL RESPONSE RULES:
- Be firm and authoritative when dealing with misconduct - you control this interview
- Keep responses short and direct for voice conversation
- NEVER include stage directions, parenthetical notes, or bracketed commentary
- Speak only what should be heard - no internal thoughts or directions
- Do not apologize for candidate misconduct - be firm and professional instead
- Do not invent or hallucinate any company-specific information
- Be honest when you don't know specific details about the company or role`}processInterviewerConfig(e,t){if(!e||!e.systemPrompt)throw h.error("ConversationHandler","Invalid interviewer config provided",{config:e}),Error("Invalid interviewer configuration: missing systemPrompt");let n=e.systemPrompt;return Object.entries(t).forEach(([e,t])=>{let a=`{{${e}}}`;n=n.replace(RegExp(a,"g"),t)}),{...e,systemPrompt:n,variables:t}}getConversationHistory(){return[...this.conversationHistory]}getStatus(){return this.status}forceResetStates(){h.info("ConversationHandler","Force resetting all states"),this.isGeneratingResponse=!1,this.isManualRecording=!1,this.audioChunks=[],this.callbacks.onSpeechEnd?.()}resetStates(){this.forceResetStates()}}let y=new b;var w=n(875);class C{async generateFeedback(e){let t=e.map(e=>`- ${e.role}: ${e.content}
`).join("");console.log("Starting client-side feedback generation",{transcriptLength:t.length});let n=`You are an AI interviewer analyzing a mock interview. Your task is to evaluate the candidate based on structured categories. Be thorough and detailed in your analysis. Don't be lenient with the candidate. If there are mistakes or areas for improvement, point them out.

Transcript:
${t}

Please analyze this interview and provide feedback in the following JSON format. IMPORTANT: Use only simple text in comments without special characters, quotes, or line breaks:

{
  "totalScore": <number 0-100>,
  "categoryScores": [
    {
      "name": "Communication Skills",
      "score": <number 0-100>,
      "comment": "detailed comment about clarity and articulation"
    },
    {
      "name": "Technical Knowledge", 
      "score": <number 0-100>,
      "comment": "detailed comment about understanding of key concepts"
    },
    {
      "name": "Problem Solving",
      "score": <number 0-100>, 
      "comment": "detailed comment about ability to analyze problems and propose solutions"
    },
    {
      "name": "Cultural Fit",
      "score": <number 0-100>,
      "comment": "detailed comment about alignment with company values and job role"
    },
    {
      "name": "Confidence and Clarity",
      "score": <number 0-100>,
      "comment": "detailed comment about confidence in responses and engagement"
    }
  ],
  "strengths": ["strength 1", "strength 2", "strength 3"],
  "areasForImprovement": ["area 1", "area 2", "area 3"],
  "finalAssessment": "overall assessment paragraph"
}

CRITICAL: Return only valid JSON with no markdown code blocks, no additional text, and no special characters in strings. Avoid apostrophes, quotes within strings, and newlines.`;try{let e;let t=await f.d.generateResponse([{role:"user",content:n}]);console.log("Raw feedback response from Ollama:",t);let a=t.trim();a.startsWith("```json")?a=a.replace(/^```json\s*/,"").replace(/\s*```$/,""):a.startsWith("```")&&(a=a.replace(/^```\s*/,"").replace(/\s*```$/,"")),a=a.replace(/[\u0000-\u001F\u007F-\u009F]/g,"").replace(/\r\n/g," ").replace(/\n/g," ").replace(/\r/g," ").replace(/\t/g," ").replace(/\s+/g," ").trim();try{e=JSON.parse(a)}catch(n){console.error("Failed to parse JSON response",{error:n,originalResponse:t.slice(0,500),cleanedResponse:a.slice(0,500)});try{let t=a.match(/\{[\s\S]*\}/);if(t){let n=t[0];n=n.replace(/\\n/g," ").replace(/\\r/g,"").replace(/\\t/g," ").replace(/\s+/g," ").trim(),e=JSON.parse(n),console.log("Successfully parsed JSON after aggressive cleaning")}else throw Error("No JSON object found in response")}catch(n){console.error("Second parsing attempt failed",{error:n,response:t.slice(0,1e3)}),e={totalScore:75,categoryScores:[{name:"Communication Skills",score:75,comment:"Analysis pending - JSON parse error"},{name:"Technical Knowledge",score:75,comment:"Analysis pending - JSON parse error"},{name:"Problem Solving",score:75,comment:"Analysis pending - JSON parse error"},{name:"Cultural Fit",score:75,comment:"Analysis pending - JSON parse error"},{name:"Confidence and Clarity",score:75,comment:"Analysis pending - JSON parse error"}],strengths:["Interview completed successfully"],areasForImprovement:["Feedback generation needs improvement"],finalAssessment:"Feedback generation encountered technical issues. Please review transcript manually."}}}return console.log("Client-side feedback generation completed",{totalScore:e.totalScore,categoriesCount:e.categoryScores.length}),e}catch(e){throw console.error("Client-side feedback generation failed:",e),e}}}let S=new C;var T=function(e){return e[e.NONE=0]="NONE",e[e.FIRST=1]="FIRST",e[e.SECOND=2]="SECOND",e[e.TERMINATED=3]="TERMINATED",e}(T||{});let E=({userName:e,userId:t,interviewId:n,feedbackId:l,type:c,questions:d})=>{let h=(0,o.useRouter)(),[u,p]=(0,i.useState)(v.INACTIVE),[g,m]=(0,i.useState)([]),[f,b]=(0,i.useState)(!1),[C,T]=(0,i.useState)(""),[E,k]=(0,i.useState)(!1),[x,I]=(0,i.useState)(!1),[N,R]=(0,i.useState)(!1),[A,H]=(0,i.useState)(0),[L,j]=(0,i.useState)(!1),O=(0,i.useRef)(!1),M=e=>[/that language is.*unacceptable/i,/inappropriate.*behavior/i,/this is your.*warning/i,/unprofessional.*conduct/i,/interview.*terminated/i,/further inappropriate/i,/completely unacceptable/i,/professional.*setting/i,/warning.*termination/i,/inappropriate.*comments/i].some(t=>t.test(e)),U=(0,i.useCallback)(()=>{let e=A+1;H(e),e>=3&&setTimeout(()=>{z()},3e3)},[A]),D=(0,i.useCallback)(()=>{console.log("\uD83D\uDD27 DEBUG: Force resetting all states"),k(!1),I(!1),R(!1),b(!1),O.current=!1,y.resetStates()},[]);(0,i.useEffect)(()=>(window.debugResetInterviewStates=D,()=>{delete window.debugResetInterviewStates}),[D]);let F=(0,i.useCallback)(()=>{console.log("Starting recording attempt...",{callStatus:u,isTranscribing:x,isGenerating:N,isRecording:E,keydownRef:O.current}),u!==v.ACTIVE||x||N||E||!(A<3)?console.log("❌ Recording blocked:",{callStatus:u,isTranscribing:x,isGenerating:N,isRecording:E,warningLevel:A}):(console.log("✅ Starting recording"),k(!0),y.startManualRecording())},[u,x,N,E,A]),P=(0,i.useCallback)(()=>{console.log("Stopping recording attempt...",{isRecording:E}),E&&(console.log("✅ Stopping recording"),k(!1),y.stopManualRecording())},[E]);(0,i.useEffect)(()=>{let e=e=>{"Space"!==e.code||O.current||(console.log("Spacebar down - starting recording"),O.current=!0,F())},t=e=>{"Space"===e.code&&O.current&&(console.log("Spacebar up - stopping recording"),O.current=!1,P())},n=e=>{"Space"===e.code&&e.preventDefault()};return document.addEventListener("keydown",e),document.addEventListener("keyup",t),document.addEventListener("keypress",n),()=>{document.removeEventListener("keydown",e),document.removeEventListener("keyup",t),document.removeEventListener("keypress",n)}},[F,P]),(0,i.useEffect)(()=>{let e=()=>{console.log("Conversation started"),p(v.ACTIVE)},t=()=>{console.log("Conversation ended"),p(v.FINISHED)},n=e=>{if(console.log("Message received:",e),"transcript"===e.type&&"final"===e.transcriptType){let t={role:e.role,content:e.transcript};"assistant"===e.role&&M(e.transcript)&&(console.log("\uD83D\uDEA8 AI issued warning response:",e.transcript),U()),m(e=>[...e,t]),"user"===e.role?(console.log("User message received - starting AI generation"),R(!0),I(!1)):"assistant"===e.role&&(console.log("Assistant response received - resetting all states"),R(!1),I(!1),k(!1))}},a=()=>{console.log("Speech started (TTS playing)"),b(!0)},s=()=>{console.log("Speech ended (TTS finished)"),b(!1)},i=e=>{console.error("Conversation error:",e),p(v.FINISHED)};return y.on("call-start",e),y.on("call-end",t),y.on("message",n),y.on("speech-start",a),y.on("speech-end",s),y.on("error",i),()=>{y.off("call-start",e),y.off("call-end",t),y.off("message",n),y.off("speech-start",a),y.off("speech-end",s),y.off("error",i)}},[U]),(0,i.useEffect)(()=>{g.length>0&&T(g[g.length-1].content);let e=async e=>{console.log("handleGenerateFeedback - client-side");try{console.log("Generating feedback with client-side Ollama...");let a=await S.generateFeedback(e);console.log("Feedback generated:",a),console.log("Saving feedback to database...");let s=await fetch("/api/save-feedback",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({interviewId:n,userId:t,feedbackId:l,totalScore:a.totalScore,categoryScores:a.categoryScores,strengths:a.strengths,areasForImprovement:a.areasForImprovement,finalAssessment:a.finalAssessment})}),i=await s.json();console.log("Save feedback response:",i),i.success&&i.feedbackId?h.push(`/interview/${n}/feedback`):(console.log("Error saving feedback:",i.error),h.push("/"))}catch(e){console.error("Error generating feedback:",e),e instanceof Error&&(e.message.includes("fetch failed")||e.message.includes("NetworkError"))&&console.error("Cannot connect to Ollama service for feedback generation"),h.push("/")}finally{j(!1)}};if(u===v.FINISHED){if("generate"===c)h.push("/");else{let t=g.filter(e=>"user"===e.role),n=g.filter(e=>"assistant"===e.role);t.length>0&&n.length>1?(j(!0),e(g)):(console.log("No meaningful conversation detected, not generating feedback"),p(v.INACTIVE))}}},[g,u,l,n,h,c,t]);let _=async()=>{try{if(console.log("Starting conversation..."),p(v.CONNECTING),H(0),"generate"===c)console.log("Starting general conversation mode"),await y.start("default",{variableValues:{username:e||"User",userid:t||"unknown"}});else{let e="";d&&(e=d.map(e=>`- ${e}`).join("\n")),console.log("Interviewer config:",w.tH),console.log("Formatted questions:",e);let t=w.tH||{systemPrompt:`You are a professional job interviewer conducting a real-time voice interview with a candidate. Your goal is to assess their qualifications, motivation, and fit for the role.

Interview Guidelines:
Follow the structured question flow:
{{questions}}

Engage naturally & react appropriately:
Listen actively to responses and acknowledge them before moving forward.
Ask brief follow-up questions if a response is vague or requires more detail.
Keep the conversation flowing smoothly while maintaining control.
Be professional, yet warm and welcoming:

Use official yet friendly language.
Keep responses concise and to the point (like in a real voice interview).
Avoid robotic phrasing—sound natural and conversational.

Handle unprofessional behavior with ZERO TOLERANCE:
If a candidate uses profanity, sexual language, inappropriate comments, or behaves unprofessionally:
- Issue an IMMEDIATE, FIRM warning without any politeness or apologies
- Be direct, authoritative, and assertive - you are in complete control
- NEVER say "I apologize" or "I understand you're frustrated" - DO NOT make excuses for their behavior
- Make it clear this behavior is completely unacceptable and will result in interview termination
- Examples of firm responses:
  * "That language is completely unacceptable in a professional interview. This is your first warning. Any further inappropriate behavior will result in immediate termination of this interview."
  * "Your behavior is unprofessional and inappropriate. This is your second warning. One more incident and this interview will be terminated immediately."
  * "This interview is being terminated due to your continued inappropriate behavior. This is unacceptable in any professional setting."
- Track warnings internally and terminate after the third offense
- Do NOT continue with interview questions after giving a warning - wait for their response first

Handle company-specific questions with strict boundaries:
- For salary, compensation, benefits: "I cannot provide specific compensation information. HR will discuss all compensation details during the next phase if you advance."
- For company policies, specific benefits, work environment: "I'm not authorized to discuss those specifics. HR will provide comprehensive information about company policies and culture."
- For role responsibilities: You can discuss general job duties and what the role typically involves
- CRITICAL: NEVER make up or invent specific salary figures, benefit amounts, company policies, or organizational details
- If you don't know something specific about the company, always redirect to HR or state you cannot provide that information
- NEVER hallucinate or create fictional company information

IMPORTANT RESPONSE RULES:
- Be firm and authoritative when dealing with misconduct - you control this interview
- Keep all your responses short and simple. Use official language, but be kind and welcoming.
- This is a voice conversation, so keep your responses short, like in a real conversation. Don't ramble for too long.
- NEVER include stage directions, parenthetical notes, or bracketed text in your responses.
- Speak only what should be heard by the candidate - no internal thoughts or directions.
- Do not use phrases like "(pause)", "(maintaining calm tone)", "[smiling]", etc.
- Your responses should be direct speech only.
- Do not apologize for candidate misconduct - be firm and professional instead.`,useStreaming:!1};console.log("Starting interview with config:",t),await y.start(t,{variableValues:{questions:e}})}}catch(e){console.error("Failed to start conversation:",e),p(v.FINISHED)}},z=async()=>{try{console.log("Stopping conversation..."),await y.stop(),p(v.FINISHED)}catch(e){console.error("Error stopping conversation:",e),p(v.FINISHED)}},V=x||N,G=(()=>{switch(A){case 1:return{color:"bg-yellow-500",text:"Warning 1/2",pulse:"animate-pulse"};case 2:return{color:"bg-orange-500",text:"Final Warning",pulse:"animate-pulse"};case 3:return{color:"bg-red-500",text:"Interview Terminated",pulse:"animate-pulse"};default:return null}})();return(console.log("Agent render state:",{callStatus:u,isRecording:E,isTranscribing:x,isGenerating:N,isSpeaking:f,warningLevel:A,messagesCount:g.length,lastMessage:C?C.slice(0,50)+"...":"No message"}),L)?(0,a.jsx)("div",{className:"fixed inset-0 flex items-center justify-center bg-gray-900 z-50",children:(0,a.jsxs)("div",{className:"flex flex-col items-center justify-center space-y-8 p-8",children:[(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)("div",{className:"w-20 h-20 border-4 border-blue-200 border-t-blue-500 rounded-full animate-spin"}),(0,a.jsx)("div",{className:"absolute inset-0 w-20 h-20 border-4 border-transparent border-r-blue-300 rounded-full animate-ping"})]}),(0,a.jsxs)("div",{className:"text-center max-w-md",children:[(0,a.jsx)("h3",{className:"text-2xl font-bold text-white mb-3",children:"Generating Your Feedback"}),(0,a.jsx)("p",{className:"text-gray-300 mb-6 text-lg",children:"Our AI is analyzing your interview performance and preparing detailed insights..."}),(0,a.jsxs)("div",{className:"flex items-center justify-center space-x-2",children:[(0,a.jsx)("div",{className:"w-3 h-3 bg-blue-500 rounded-full animate-pulse"}),(0,a.jsx)("div",{className:"w-3 h-3 bg-blue-500 rounded-full animate-pulse",style:{animationDelay:"0.2s"}}),(0,a.jsx)("div",{className:"w-3 h-3 bg-blue-500 rounded-full animate-pulse",style:{animationDelay:"0.4s"}})]})]})]})}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:"call-view",children:[G&&(0,a.jsx)("div",{className:(0,r.cn)("fixed top-4 right-4 z-50 px-4 py-2 rounded-lg text-white font-semibold shadow-lg",G.color,G.pulse),children:G.text}),(0,a.jsxs)("div",{className:"card-interviewer",children:[(0,a.jsxs)("div",{className:"avatar",children:[(0,a.jsx)(s.default,{src:"/ai-avatar.png",alt:"profile-image",width:65,height:54,className:"object-cover"}),f&&(0,a.jsx)("span",{className:"animate-speak"})]}),(0,a.jsx)("h3",{children:"AI Interviewer"})]}),(0,a.jsx)("div",{className:"card-border",children:(0,a.jsxs)("div",{className:"card-content",children:[(0,a.jsx)(s.default,{src:"/user-avatar.png",alt:"profile-image",width:539,height:539,className:"rounded-full object-cover size-[120px]"}),(0,a.jsx)("h3",{children:e}),E&&(0,a.jsxs)("div",{className:"flex items-center gap-2 mt-2",children:[(0,a.jsx)("div",{className:"w-3 h-3 bg-red-500 rounded-full animate-pulse"}),(0,a.jsx)("span",{className:"text-sm text-red-500 font-medium",children:"Recording..."})]}),x&&(0,a.jsxs)("div",{className:"flex items-center gap-2 mt-2",children:[(0,a.jsx)("div",{className:"w-3 h-3 bg-blue-500 rounded-full animate-pulse"}),(0,a.jsx)("span",{className:"text-sm text-blue-500 font-medium",children:"Transcribing..."})]}),N&&(0,a.jsxs)("div",{className:"flex items-center gap-2 mt-2",children:[(0,a.jsx)("div",{className:"w-3 h-3 bg-green-500 rounded-full animate-pulse"}),(0,a.jsx)("span",{className:"text-sm text-green-500 font-medium",children:"Generating..."})]})]})})]}),g.length>0&&C&&(0,a.jsx)("div",{className:"transcript-border",children:(0,a.jsx)("div",{className:"transcript",children:(0,a.jsx)("p",{className:(0,r.cn)("transition-opacity duration-500 opacity-0","animate-fadeIn opacity-100"),children:C},C)})}),(0,a.jsxs)("div",{className:"w-full flex flex-col items-center gap-4",children:[(0,a.jsxs)("div",{className:"text-xs text-gray-400 mb-2",children:["Status: ",u," | Recording: ",E?"Yes":"No"," | Transcribing: ",x?"Yes":"No"," | Generating: ",N?"Yes":"No"," | Warnings: ",A,"/2"]}),u!==v.ACTIVE?(0,a.jsxs)("button",{className:"relative btn-call",onClick:()=>_(),children:[(0,a.jsx)("span",{className:(0,r.cn)("absolute animate-ping rounded-full opacity-75",u!==v.CONNECTING&&"hidden")}),(0,a.jsx)("span",{className:"relative text-black",children:u===v.INACTIVE||u===v.FINISHED?"Start Interview":"Connecting..."})]}):(0,a.jsxs)("div",{className:"flex flex-col items-center gap-2",children:[(0,a.jsxs)("div",{className:"flex items-center gap-6",children:[(0,a.jsx)("button",{className:(0,r.cn)("relative transition-all duration-200 flex items-center justify-center rounded-full w-36 h-12 border-0",E?"bg-red-500 hover:bg-red-600 scale-110 shadow-lg":x?"bg-blue-500 hover:bg-blue-600":N?"bg-green-500 hover:bg-green-600":"bg-blue-500 hover:bg-blue-600",(V||A>=3)&&"opacity-50 cursor-not-allowed"),onMouseDown:F,onMouseUp:P,onMouseLeave:P,onTouchStart:F,onTouchEnd:P,disabled:V||A>=3,children:A>=3?(0,a.jsx)("span",{className:"relative z-10 font-medium text-xs px-2 text-center",children:"Terminated"}):(0,a.jsxs)("svg",{className:"w-6 h-6 text-white",fill:"currentColor",viewBox:"0 0 24 24",children:[(0,a.jsx)("path",{d:"M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"}),(0,a.jsx)("path",{d:"M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"})]})}),(0,a.jsx)("button",{className:"btn-disconnect",onClick:z,children:"End Interview"})]}),(0,a.jsx)("p",{className:"text-xs text-gray-500 text-center max-w-md",children:A>=3?"This interview has been terminated due to inappropriate behavior.":"Hold the button above or press and hold SPACEBAR to speak"})]})]})]})}},5152:(e,t,n)=>{n.d(t,{d:()=>s});class a{constructor(){this.baseUrl=process.env.NEXT_PUBLIC_OLLAMA_URL||"https://dypai.ccxai.uk",this.model=process.env.NEXT_PUBLIC_OLLAMA_MODEL||"gemma3:latest",console.log("ClientOllamaAdapter initialized:",{baseUrl:this.baseUrl,model:this.model})}async generateResponse(e){console.log("Starting client-side LLM generation",{messageCount:e.length,model:this.model,baseUrl:this.baseUrl});try{let t=await fetch(`${this.baseUrl}/api/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:this.model,messages:e,stream:!1})});if(!t.ok)throw Error(`Ollama responded with status: ${t.status} - ${t.statusText}`);let n=await t.json(),a=n.message.content;return console.log("Client-side LLM generation completed",{responseLength:a.length,totalDuration:n.total_duration,evalCount:n.eval_count}),a}catch(e){throw console.error("Client-side LLM generation failed:",e),e}}async testConnection(){try{console.log("Testing client-side Ollama connection");let e=await fetch(`${this.baseUrl}/api/tags`);if(!e.ok)return console.log("Client-side Ollama health check:",{status:"unhealthy",statusCode:e.status}),!1;{let t=await e.json(),n=t.models?.some(e=>e.name.includes(this.model.split(":")[0]));return console.log("Client-side Ollama health check:",{status:"healthy",modelAvailable:n,availableModels:t.models?.map(e=>e.name)||[]}),n}}catch(e){return console.error("Client-side Ollama health check failed:",e),!1}}}let s=new a},57:(e,t,n)=>{n.d(t,{default:()=>a});let a=(0,n(2305).registerClientReference)(function(){throw Error("Attempted to call the default export of \"C:\\\\Users\\\\sudar\\\\Downloads\\\\interview-ai\\\\components\\\\Agent.tsx\" from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"C:\\Users\\sudar\\Downloads\\interview-ai\\components\\Agent.tsx","default")}};